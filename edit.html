<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Web App</title>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="/Web-App/style.css" />
        <link rel="shortcut icon" href="#" />
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <script>
            const { createClient } = supabase;
        </script>
        <script src="/Web-App/supabase.js"></script>
    </head>
    <body style="display: flex; align-items: center; flex-direction: column">
        <div style="display: flex; justify-content: space-between; padding: 0.5rem; width: 100%">
            <h1>This is the edit page</h1>
            <button onclick="console.log('Changes saved')">Save</button>
        </div>

        <table id="schedule">
            <tr id="0">
                <th id="00">Time</th>
                <th id="10">Monday</th>
                <th id="20">Tuesday</th>
                <th id="30">Wednesday</th>
                <th id="40">Thursday</th>
                <th id="50">Friday</th>
            </tr>
            <tr id="1">
                <th id="01">08:40</th>
                <th id="11"></th>
                <th id="21"></th>
                <th id="31"></th>
                <th id="41"></th>
                <th id="51"></th>
            </tr>
            <tr id="2">
                <th id="02">09:40</th>
                <th id="12"></th>
                <th id="22"></th>
                <th id="32"></th>
                <th id="42"></th>
                <th id="52"></th>
            </tr>
            <tr id="3">
                <th id="03">10:40</th>
                <th id="13"></th>
                <th id="23"></th>
                <th id="33"></th>
                <th id="43"></th>
                <th id="53"></th>
            </tr>
            <tr id="4">
                <th id="04">11:40</th>
                <th id="14"></th>
                <th id="24"></th>
                <th id="34"></th>
                <th id="44"></th>
                <th id="54"></th>
            </tr>
            <tr id="5">
                <th id="05">12:40</th>
                <th id="15"></th>
                <th id="25"></th>
                <th id="35"></th>
                <th id="45"></th>
                <th id="55"></th>
            </tr>
            <tr id="6">
                <th id="06">13:40</th>
                <th id="16"></th>
                <th id="26"></th>
                <th id="36"></th>
                <th id="46"></th>
                <th id="56"></th>
            </tr>
            <tr id="7">
                <th id="07">14:40</th>
                <th id="17"></th>
                <th id="27"></th>
                <th id="37"></th>
                <th id="47"></th>
                <th id="57"></th>
            </tr>
            <tr id="8">
                <th id="08">15:40</th>
                <th id="18"></th>
                <th id="28"></th>
                <th id="38"></th>
                <th id="48"></th>
                <th id="58"></th>
            </tr>
            <tr id="9">
                <th id="09">16:40</th>
                <th id="19"></th>
                <th id="29"></th>
                <th id="39"></th>
                <th id="49"></th>
                <th id="59"></th>
            </tr>
            <tr id="a">
                <th id="0a">17:40</th>
                <th id="1a"></th>
                <th id="2a"></th>
                <th id="3a"></th>
                <th id="4a"></th>
                <th id="5a"></th>
            </tr>
            <tr id="b">
                <th id="0b">18:40</th>
                <th id="1b"></th>
                <th id="2b"></th>
                <th id="3b"></th>
                <th id="4b"></th>
                <th id="5b"></th>
            </tr>
            <tr id="c">
                <th id="0c">19:40</th>
                <th id="1c"></th>
                <th id="2c"></th>
                <th id="3c"></th>
                <th id="4c"></th>
                <th id="5c"></th>
            </tr>
        </table>

        <dialog id="modal">
            <form method="dialog">
                <button onclick="modalSave()">Save</button>
                <button onclick="">Cancel</button>
            </form>
        </dialog>
    </body>

    <!-- main script -->
    <script type="text/javascript">
        // check if a user is signed in otherwise redirect to signin
        document.addEventListener("DOMContentLoaded", async function () {
            const userid = await checkSession();
            if (userid) {
                console.log(userid);
            } else {
                window.location.href = "/Web-App/auth/signin.html";
            }

            getData(userid);

            const schedule = document.getElementById("schedule");
            window.addEventListener(
                "resize",
                debounce(function () {
                    schedule.style.fontSize = Math.min(window.innerWidth / 40, 24) + "px";
                }, 100)
            );
            schedule.style.fontSize = Math.min(window.innerWidth / 40, 24) + "px";
        });

        function debounce(func, interval) {
            var lastCall = -1;
            return function () {
                clearTimeout(lastCall);
                var args = arguments;
                var self = this;
                lastCall = setTimeout(function () {
                    func.apply(self, args);
                }, interval);
            };
        }

        async function getData(userid) {
            let { data: course, error } = await supabase.from("course").select("*");

            if (error) {
                console.error("Error:", error.message);
            } else {
                console.log("Data:", course);
            }

            fillSchedule(course);
        }

        async function fillSchedule(data) {
            data.forEach((course) => {
                const th = document.getElementById(`${course.col}${course.row.toString(16)}`);
                th.innerHTML = `${course.name} (${course.section}) [${course.room}]`;
                th.style.backgroundColor = course.color;
            });

            document.querySelectorAll("th").forEach((th) => {
                let course = {
                    name: th.innerHTML.match(/\w{6,8}|\w{3,4} \d{3,4}/),
                    section: th.innerHTML.search(/(\w+)/),
                    room: th.innerHTML.search(/[\w+]/),
                };
                console.log(course);
                th.addEventListener("click", () => {
                    openModal(
                        course.name,
                        course.section,
                        course.room,
                        th.style.backgroundColor,
                        th.id
                    );
                });
            });
        }

        function openModal(name, section, room, color, id) {
            const modal = document.getElementById("modal");
            const inside = document.createElement("div");
            inside.innerHTML = `
                <h2>${name}</h2>
                <p>Section: ${section}</p>
                <p>Room: ${room}</p>
            `;

            modal.style.backgroundColor = color;
            modal.prepend(inside)
            modal.showModal();
        }

        function modalSave() {
            console.log("saved changes")
        }
    </script>
</html>
