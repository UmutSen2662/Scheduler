<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Scheduler</title>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0" />
        <link rel="manifest" href="/Scheduler/manifest.json" />
        <link rel="stylesheet" href="/Scheduler/style.css" />
        <link rel="shortcut icon" href="/Scheduler/scheduler any.png" />
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <script>
            const { createClient } = supabase;
        </script>
        <script src="/Scheduler/supabase.js"></script>
    </head>
    <body style="display: flex; align-items: center; flex-direction: column">
        <div style="display: flex; justify-content: space-between; padding: 0.5rem; width: 100%">
            <h2>METU Schedule and CEF</h2>
            <button id="signInOut" style="padding: 0.6rem" onclick="signInOut()">Sign In</button>
        </div>

        <h2 style="padding: 0.5rem">Schedule</h2>
        <table id="schedule" style="font-weight: 700">
            <tr id="0">
                <th id="00">Time</th>
                <th id="10">Monday</th>
                <th id="20">Tuesday</th>
                <th id="30">Wednesday</th>
                <th id="40">Thursday</th>
                <th id="50">Friday</th>
            </tr>
            <tr id="1">
                <td id="01">08:40</td>
                <td id="11"></td>
                <td id="21"></td>
                <td id="31"></td>
                <td id="41"></td>
                <td id="51"></td>
            </tr>
            <tr id="2">
                <td id="02">09:40</td>
                <td id="12"></td>
                <td id="22"></td>
                <td id="32"></td>
                <td id="42"></td>
                <td id="52"></td>
            </tr>
            <tr id="3">
                <td id="03">10:40</td>
                <td id="13"></td>
                <td id="23"></td>
                <td id="33"></td>
                <td id="43"></td>
                <td id="53"></td>
            </tr>
            <tr id="4">
                <td id="04">11:40</td>
                <td id="14"></td>
                <td id="24"></td>
                <td id="34"></td>
                <td id="44"></td>
                <td id="54"></td>
            </tr>
            <tr id="5">
                <td id="05">12:40</td>
                <td id="15"></td>
                <td id="25"></td>
                <td id="35"></td>
                <td id="45"></td>
                <td id="55"></td>
            </tr>
            <tr id="6">
                <td id="06">13:40</td>
                <td id="16"></td>
                <td id="26"></td>
                <td id="36"></td>
                <td id="46"></td>
                <td id="56"></td>
            </tr>
            <tr id="7">
                <td id="07">14:40</td>
                <td id="17"></td>
                <td id="27"></td>
                <td id="37"></td>
                <td id="47"></td>
                <td id="57"></td>
            </tr>
            <tr id="8">
                <td id="08">15:40</td>
                <td id="18"></td>
                <td id="28"></td>
                <td id="38"></td>
                <td id="48"></td>
                <td id="58"></td>
            </tr>
            <tr id="9">
                <td id="09">16:40</td>
                <td id="19"></td>
                <td id="29"></td>
                <td id="39"></td>
                <td id="49"></td>
                <td id="59"></td>
            </tr>
            <tr id="a">
                <td id="0a">17:40</td>
                <td id="1a"></td>
                <td id="2a"></td>
                <td id="3a"></td>
                <td id="4a"></td>
                <td id="5a"></td>
            </tr>
            <tr id="b">
                <td id="0b">18:40</td>
                <td id="1b"></td>
                <td id="2b"></td>
                <td id="3b"></td>
                <td id="4b"></td>
                <td id="5b"></td>
            </tr>
            <tr id="c">
                <td id="0c">19:40</td>
                <td id="1c"></td>
                <td id="2c"></td>
                <td id="3c"></td>
                <td id="4c"></td>
                <td id="5c"></td>
            </tr>
        </table>

        <input
            type="text"
            id="courseCodes"
            placeholder="Enter course codes (CNG315 CNG445 ENGL311 ...)"
        />
        <div id="examsContainer">
            <table id="exams">
                <tr>
                    <th>Course Exam</th>
                    <th>Days Until</th>
                    <th>Days Between</th>
                    <th>Start Time</th>
                    <th>Classrooms</th>
                </tr>
            </table>
        </div>

        <dialog id="modal">
            <div style="padding: 1rem">
                <div id="modalInside"></div>
                <div id="modalColor">
                    <button
                        style="background: #f0f0f0"
                        onclick="Modal.set('color', ''); modalButtons(this.style.backgroundColor);"
                    ></button>
                    <button
                        style="background: #ff2a2a"
                        onclick="Modal.set('color', this.style.backgroundColor); modalButtons(this.style.backgroundColor);"
                    ></button>
                    <button
                        style="background: #ff9515"
                        onclick="Modal.set('color', this.style.backgroundColor); modalButtons(this.style.backgroundColor);"
                    ></button>
                    <button
                        style="background: #ffff00"
                        onclick="Modal.set('color', this.style.backgroundColor); modalButtons(this.style.backgroundColor);"
                    ></button>
                    <button
                        style="background: #b6ff00"
                        onclick="Modal.set('color', this.style.backgroundColor); modalButtons(this.style.backgroundColor);"
                    ></button>
                    <button
                        style="background: #00b020"
                        onclick="Modal.set('color', this.style.backgroundColor); modalButtons(this.style.backgroundColor);"
                    ></button>
                    <button
                        style="background: #00ffc0"
                        onclick="Modal.set('color', this.style.backgroundColor); modalButtons(this.style.backgroundColor);"
                    ></button>
                    <button
                        style="background: #40d0ff"
                        onclick="Modal.set('color', this.style.backgroundColor); modalButtons(this.style.backgroundColor);"
                    ></button>
                    <button
                        style="background: #3080ff"
                        onclick="Modal.set('color', this.style.backgroundColor); modalButtons(this.style.backgroundColor);"
                    ></button>
                    <button
                        style="background: #9752cb"
                        onclick="Modal.set('color', this.style.backgroundColor); modalButtons(this.style.backgroundColor);"
                    ></button>
                </div>
                <form method="dialog">
                    <button style="margin-right: auto; background: #e00" onclick="modalDelete()">
                        Delete
                    </button>
                    <button style="margin-right: 0.4rem" onclick="modalSave()">Save</button>
                    <button style="background: #999" onclick="">Cancel</button>
                </form>
            </div>
        </dialog>
        <a style="margin: 1rem; margin-left: auto" href="https://github.com/UmutSen2662/Scheduler"
            >GitHub Page</a
        >
    </body>

    <!-- main script -->
    <script type="text/javascript">
        // check if a user is signed in otherwise redirect to signin
        document.addEventListener("DOMContentLoaded", async function () {
            window.userid = await checkSession();
            if (window.userid) {
                const signInOut = document.getElementById("signInOut");
                signInOut.style.backgroundColor = "#888";
                signInOut.innerHTML = "Sign Out";
            }
            if (!localStorage.getItem("course")) localStorage.setItem("course", "[]");
            if (!localStorage.getItem("course_codes")) localStorage.setItem("course_codes", "");
            await getData();

            const modal = document.getElementById("modal");
            modal.addEventListener("click", (event) => {
                if (event.target == modal) modal.close();
            });

            const courseCodes = document.getElementById("courseCodes");
            const debouncedEvalCourseCodes = debounce(evalCourseCodes, 1000);
            courseCodes.addEventListener("input", () => {
                debouncedEvalCourseCodes(courseCodes.value);
            });
            evalCourseCodes(courseCodes.value);

            const schedule = document.getElementById("schedule");
            const debouncedResize = debounce(resize, 300);
            window.addEventListener("resize", () => debouncedResize(schedule));
            resize(schedule);
        });

        async function evalCourseCodes(courseCodes) {
            const set = new Set();
            courseCodes
                .toUpperCase()
                .matchAll(/([A-Z]{3,4})\s?(\d{3,4})/g)
                .forEach((r) => set.add(r[1] + r[2]));

            const str = Array.from(set).join(" ");

            // Depending on if the user is signed in or not, store the course codes in either the local storage or the database
            localStorage.setItem("course_codes", str);
            if (window.userid) {
                const { error } = await supabase
                    .from("course_codes")
                    .upsert({ userid: window.userid, courses: str });
                if (error) {
                    console.error(error);
                }
            }

            const exams = document.getElementById("exams");
            const { data: data } = await supabase.from("exams").select("*"); // this is not user dependent no need to check userid
            let prevDate = Date.now();
            exams.querySelectorAll("tr:not(:first-child)").forEach((tr) => tr.remove());
            data.forEach((exam) => {
                if (!set.has(exam.course_exam.match(/[A-Z]{3,4}\s?\d{3,4}/g)[0].replace(" ", "")))
                    return; // skip if the course code is not in the set

                const dateObj = new Date(exam.start_time);
                // Get the components of the date
                const year = dateObj.getFullYear();
                const month = String(dateObj.getMonth() + 1).padStart(2, "0"); // Month is zero-indexed, so add 1
                const day = String(dateObj.getDate()).padStart(2, "0");
                const weekday = dateObj.toLocaleString("en-US", { weekday: "short" });
                const hour = String(dateObj.getHours()).padStart(2, "0");
                const minute = String(dateObj.getMinutes()).padStart(2, "0");
                // Format the string
                const formattedDate = `${year}-${month}-${day} ${weekday} ${hour}:${minute}`;
                const now = Date.now() - new Date().getTimezoneOffset() * 60000;
                const today = now - (now % 86400000);
                const date = dateObj.getTime() - (dateObj.getTime() % 86400000);

                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${exam.course_exam}</td><td>${Math.max(
                    Math.floor(date / 86400000) - Math.floor(today / 86400000),
                    0
                )}</td><td>${Math.max(
                    Math.floor(date / 86400000) - Math.floor(prevDate / 86400000),
                    0
                )}</td><td>${formattedDate}</td><td>${exam.classrooms}</td>`;
                exams.appendChild(tr);
                prevDate = date;
            });
        }

        function resize(schedule) {
            schedule.style.fontSize =
                Math.min(document.documentElement.clientWidth / 40, 20) + "px";
        }

        function debounce(func, interval) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), interval);
            };
        }

        async function getData() {
            if (window.userid) {
                const { data: course } = await supabase.from("course").select("*");
                if (course)
                    if (course.length > 0) {
                        const mapped = course.map((c) => ({
                            name: c.name,
                            section: c.section,
                            room: c.room,
                            color: c.color,
                            row: c.row,
                            col: c.col,
                        }));
                        localStorage.setItem("course", JSON.stringify(mapped));
                    }

                const { data: data } = await supabase.from("course_codes").select("courses");
                if (data)
                    if (data.length > 0) localStorage.setItem("course_codes", data[0].courses);
            }
            document.getElementById("courseCodes").value = localStorage.getItem("course_codes");

            fillSchedule(JSON.parse(localStorage.getItem("course")));
        }

        async function fillSchedule(data) {
            data.forEach((course) => {
                const td = document.getElementById(`${course.col}${course.row.toString(16)}`);
                td.innerHTML = `${course.name} (${course.section}) [${course.room}]`;
                td.style.backgroundColor = course.color;
            });

            const schedule = document.getElementById("schedule");
            schedule.querySelectorAll("td").forEach((td) => {
                if (td.id[0] == "0" || td.id[1] == "0") return;
                td.style.cursor = "pointer";
                td.addEventListener("click", () => {
                    clicked.call(td);
                });
            });
        }

        function clicked() {
            let name = this.innerHTML.match(/.+ \(/);
            let section = this.innerHTML.match(/\(.+\)/);
            let room = this.innerHTML.match(/\[.+\]/);

            name = name == null ? "" : name[0].slice(0, -2);
            section = section == null ? "" : section[0].slice(1, -1);
            room = room == null ? "" : room[0].slice(1, -1);

            openModal(name, section, room, this.style.backgroundColor, this.id);
        }

        const Modal = (function () {
            const data = {};

            return {
                set(key, value) {
                    data[key] = value;
                },
                get(key) {
                    return data[key];
                },
            };
        })();

        function modalButtons(color) {
            const colors = document.getElementById("modalColor");
            Array.from(colors.children)
                .filter((node) => node.tagName == "BUTTON")
                .forEach((btn) => {
                    if (btn.style.backgroundColor == color) btn.classList.add("active");
                    else btn.classList.remove("active");
                });
        }

        function openModal(name, section, room, color, id) {
            const modal = document.getElementById("modal");
            const inside = document.getElementById("modalInside");

            modalButtons(color);
            Modal.set("id", id);
            Modal.set("color", color);
            inside.innerHTML = `
                <input type="text" id="modalName" placeholder="Name" value="${name}">
                <input type="text" id="modalSection" placeholder="Section" value="${section}">
                <input type="text" id="modalRoom" placeholder="Room" value="${room}">
            `;
            modal.showModal();
        }

        async function modalSave() {
            const nameInput = document.getElementById("modalName");
            const sectionInput = document.getElementById("modalSection");
            const roomInput = document.getElementById("modalRoom");

            const id = Modal.get("id");
            const name = nameInput.value;
            const section = sectionInput.value;
            const room = roomInput.value;

            const td = document.getElementById(id);
            td.innerHTML = `${name} (${section}) [${room}]`;
            td.style.backgroundColor = Modal.get("color");

            if (window.userid) {
                const { error } = await supabase.from("course").upsert({
                    userid: window.userid,
                    name: name,
                    section: section,
                    room: room,
                    color: td.style.backgroundColor,
                    col: parseInt(id[0], 16),
                    row: parseInt(id[1], 16),
                });
                if (error) console.log(error);
            }
            let found = false;
            const course = JSON.parse(localStorage.getItem("course"));
            course.forEach((c) => {
                if (c.col == parseInt(id[0], 16) && c.row == parseInt(id[1], 16)) {
                    c.name = name;
                    c.section = section;
                    c.room = room;
                    c.color = td.style.backgroundColor;
                    found = true;
                }
                if (!found) {
                    course.push({
                        name: name,
                        section: section,
                        room: room,
                        color: td.style.backgroundColor,
                        col: parseInt(id[0], 16),
                        row: parseInt(id[1], 16),
                    });
                }
            });
            localStorage.setItem("course", JSON.stringify(course));
        }

        async function modalDelete() {
            const id = Modal.get("id");
            const td = document.getElementById(id);
            td.style.backgroundColor = "";
            td.innerHTML = "";

            if (window.userid) {
                const { error } = await supabase
                    .from("course")
                    .delete()
                    .eq("userid", window.userid)
                    .eq("col", parseInt(id[0], 16))
                    .eq("row", parseInt(id[1], 16));
                console.log(error);
            }
            const course = JSON.parse(localStorage.getItem("course"));
            const filtered = course.filter(
                (c) => c.col != parseInt(id[0], 16) || c.row != parseInt(id[1], 16)
            );
            localStorage.setItem("course", JSON.stringify(filtered));
        }
    </script>
</html>
